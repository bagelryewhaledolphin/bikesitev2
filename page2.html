<!DOCTYPE html>
<html>
<head>
  <script type='text/javascript' src='https://cdn.scaledrone.com/scaledrone.min.js'></script>
  <!--<script type='text/javascript' src='http://0.0.0.0:8080/scaledrone.js'></script>-->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">

  <style>.float-container {
    border: 0px solid #fff;
    padding: 20px;
}

.float-child {
    width:15%;
    float: left;
    padding: 20px;
    border: 0px solid rgb(0,0,0);
}
.float-child1 {
    width: 80%;
    float: left;
    padding: 0px;
    border: 0x solid red;
}  </style>


  <style>
*{
border-radius: 25px;}
    body {
      box-sizing: border-box;
      padding: 30px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .members-list,
    .messages {
      border: 1px solid #e4e4e4;
      padding: 15px;
      background:#F2F2F2
    }

    .messages {
      flex-shrink: 1;
      overflow: auto;
    }

    .message {
      padding: 5px 0;
    }
    .message .member {
      display: inline-block;
    }

    .member {
      padding-right: 10px;
      position: relative;
    }

    .message-form {
      display: flex;
      flex-shrink: 0;
      margin-bottom: 15px;
      border-radius: 25px;
      padding: 20px; 
    }
    .message-form__input {
      flex-grow: 1;
      border: 1px solid #dfdfdf;
      padding: 10px 15px;

      margin-bottom: 15px;
      border-radius: 25px;
      background: #F2F2F2;
      padding: 20px; 
    }
    .message-form__button {
      border: 1px;
      padding: 10px;

      background-color: blue;
      margin-bottom: 15px;
      border-radius: 25px;
      background: #7CDE7C;
      padding: 30px; 
    }
    body{
        background-color: white;
    }
  </style>
</head>
<body>
  <div class="float-child1" id="myDIV">
  <a href="../index.html" class="nav-home"> </a>

      <h3 style="color: grey;">Chatroom 2</h3>
      <h3 style="color: grey;">In the chatrooms, no message history is saved, so after reload, all messages are lost. This prevents clutter</h3>

  <div style= "color:grey;     max-height: 500px;
  " id="one"class="messages"><strong></strong></div>
  <form class="message-form" onsubmit="return false;">
    <input class="message-form__input" placeholder="Type a message.." type="text"/>
    <input class="message-form__button" id="mfi" value="Send" type="submit"/>

    
  </form>
  </div>

</body>
</html>
<div class="float-child" id="myDIV">
  <h2 style="color: grey;"><strong>Online Now</strong></h2>
  <div class="members-count">-</div>

  <div style="color: black;"class="members-list">-</div>

</div>
<script>
const d=new Date();
var code="0"
 if(code){
let id="hi"

    // PS! Replace this with your own channel ID
// If you use this channel ID your app will stop working in the future
var usernameroom2 = localStorage.getItem("usernameroom2");
if(!usernameroom2){
    usernameroom2 = prompt("Please enter your first and last name.");
    localStorage.setItem("usernameroom2", usernameroom2);
}
  let p =  usernameroom2;
const CLIENT_ID = 'H6alsQVbSnsHRDaE';
const drone = new ScaleDrone(CLIENT_ID, {
  data: { // Will be sent out as clientData via events
    name:p,
    color: '#7CDE7C',
  },
});
while(name==null){
    name=alert("Sending without user-name!");
}
let members = [];

drone.on('open', error => {
  if (error) {
    return console.error(error);
  }
  console.log('Successfully connected to Chat');
  const room = drone.subscribe('observable-room', {
    historyCount: 100 // ask for the latest message from history
  });
  room.on('open', error => {
    if (error) {
      return console.error(error);
    }
    console.log('Successfully joined room');
  });

  room.on('members', m => {
    members = m;
    updateMembersDOM();
  });

  room.on('member_join', member => {
    members.push(member);
    updateMembersDOM();
  });

room.on('member_leave', ({id}) => {
    const index = members.findIndex(member => member.id === id);
    members.splice(index, 1);
    updateMembersDOM();
  });

hist=[];

room.on('history_message', ({data}) => {
    document.getElementById("one").innerHTML=document.getElementById("one").innerHTML+"<br>"+data;

});
  room.on('data', (text, member) => {
    if (member) {
      addMessageToListDOM(text, member);
    } else {
      // Message is from server
    }
  });
});

drone.on('close', event => {
  console.log('Connection was closed', event);
});

drone.on('error', error => {
  console.error(error);
});

function getRandomName() {
 console.log("Got random name!");
}


//------------- DOM STUFF

const DOM = {
  membersCount: document.querySelector('.members-count'),
  membersList: document.querySelector('.members-list'),
  messages: document.querySelector('.messages'),
  input: document.querySelector('.message-form__input'),
  form: document.querySelector('.message-form'),
};

DOM.form.addEventListener('submit', sendMessage);

function sendMessage(member) {
  const value1 = member.name;
  const value = DOM.input.value;
  if (value === '') {
    return;
  }
const d = new Date();
let text = d.toTimeString();
let text3 = d.toDateString();

let text2 = text.substring(0,5)+" "+text3.substring(4,text3.length-5);
  DOM.input.value = '';
  drone.publish({
    room: 'observable-room',
    message:text2+"   "+p+": "+value,
//messageshere
 
  });
}

function createMemberElement(member) {
  const { name, color } = member.clientData;
  const el = document.createElement('div');
  el.appendChild(document.createTextNode(name));
  el.className = 'member';
  el.style.color = color;
  return el;
}

function updateMembersDOM() {
  DOM.membersCount.innerText = ``;
  DOM.membersList.innerHTML = '';
  members.forEach(member =>
    DOM.membersList.appendChild(createMemberElement(member))
  );
}

function createMessageElement(text, member) {
  while(text==null){
    text=prompt("Please Enter Valid User-Name!")
  }
  const el = document.createElement('div');
  el.appendChild(createMemberElement(member));
  el.appendChild(document.createTextNode(text));
  el.className = 'message';
  return el;
}




function addMessageToListDOM(text, member) {
  const el = DOM.messages;
  const wasTop = el.scrollTop === el.scrollHeight - el.clientHeight;
  el.appendChild(createMessageElement(text, member));
  if (wasTop) {
    el.scrollTop = el.scrollHeight - el.clientHeight;
  }
}
}




else{


}
</script>
